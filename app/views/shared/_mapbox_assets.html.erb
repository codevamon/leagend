<%# app/views/shared/_mapbox_assets.html.erb %>
<%# CSS de Mapbox (no requiere nonce) %>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css">
<% if local_assigns[:load_geocoder] != false %>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css">
<% end %>

<%= javascript_tag nonce: content_security_policy_nonce do %>
  (function () {
    // Guard para evitar cargas duplicadas
    if (typeof window.__mapboxAssetsLoaded === 'undefined') {
      window.__mapboxAssetsLoaded = false;
    }

    // Cargar Mapbox GL si no existe
    if (!window.__mapboxAssetsLoaded && typeof mapboxgl === 'undefined') {
      var s = document.createElement('script');
      s.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
      s.onload = function () {
        console.log('Mapbox GL JS cargado');
        window.dispatchEvent(new CustomEvent('mapboxgl:loaded'));
      };
      s.onerror = function () { console.error('Error al cargar Mapbox GL JS'); };
      document.head.appendChild(s);
    } else if (typeof mapboxgl !== 'undefined') {
      // Ya disponible
      window.dispatchEvent(new CustomEvent('mapboxgl:loaded'));
    }
  })();
<% end %>

<% if local_assigns[:load_geocoder] != false %>
<%= javascript_tag nonce: content_security_policy_nonce do %>
  (function () {
    function loadGeocoder() {
      if (typeof mapboxgl !== 'undefined' && typeof MapboxGeocoder === 'undefined') {
        var s = document.createElement('script');
        s.src = 'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js';
        s.onload = function () {
          console.log('Mapbox Geocoder JS cargado');
          window.__mapboxAssetsLoaded = true;
          window.dispatchEvent(new CustomEvent('mapboxgeocoder:loaded'));
        };
        s.onerror = function () { console.error('Error al cargar Mapbox Geocoder JS'); };
        document.head.appendChild(s);
      } else if (typeof MapboxGeocoder !== 'undefined') {
        window.__mapboxAssetsLoaded = true;
        window.dispatchEvent(new CustomEvent('mapboxgeocoder:loaded'));
      } else {
        setTimeout(loadGeocoder, 100);
      }
    }

    // Escuchar a GL y/o cargar directo si ya est√°
    window.addEventListener('mapboxgl:loaded', loadGeocoder);
    if (typeof mapboxgl !== 'undefined') loadGeocoder();
  })();
<% end %>
<% end %>
