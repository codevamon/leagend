<h1>Selecciona una Arena para el duelo</h1>

<div id="map" class="mapbox-container mb-3"></div>

<ul>
  <% @arenas.each do |arena| %>
    <li>
      <strong><%= arena.name %></strong><br>
      <%= arena.address %> - <%= arena.city %>
      <%= button_to 'Seleccionar esta arena',
          duel_path(@duel, arena_id: arena.id),
          method: :patch,
          class: "btn btn-sm btn-primary mt-2" %>
    </li>
  <% end %>
</ul>

<hr>

<h2>Duelos compatibles</h2>

<% if @duelos_compatibles.any? %>
  <ul>
    <% @duelos_compatibles.each do |duelo| %>
      <li>
        <%= link_to "Duelo ##{duelo.id} - #{duelo.starts_at.strftime("%d/%m %H:%M")}", duel_path(duelo) %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>No hay duelos compatibles disponibles.</p>
<% end %>

<%# Assets de Mapbox con nonces %>
<%= render 'shared/mapbox_assets' %>

<%= javascript_tag nonce: content_security_policy_nonce do %>
  // Esperar a que Mapbox esté disponible
  function initializeMap() {
    if (typeof mapboxgl === 'undefined') {
      setTimeout(initializeMap, 100);
      return;
    }
    
    mapboxgl.accessToken = '<%= Rails.application.credentials.dig(:mapbox, :public_token) %>';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [<%= current_user.longitude || -74.0721 %>, <%= current_user.latitude || 4.7110 %>],
      zoom: 12
    });

    <% @arenas.each do |arena| %>
      new mapboxgl.Marker()
        .setLngLat([<%= arena.longitude %>, <%= arena.latitude %>])
        .setPopup(new mapboxgl.Popup().setText("<%= arena.name %>"))
        .addTo(map);
    <% end %>
  }
  
  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', initializeMap);
<% end %>
