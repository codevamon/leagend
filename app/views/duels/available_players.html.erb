<%# Vista para mostrar jugadores disponibles después de crear equipo temporal %>
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="fas fa-users me-2"></i>Convocar Jugadores
        </h2>
        <div class="d-flex gap-2">
          <%= link_to manage_duel_path(@duel), class: "btn btn-outline-secondary btn-sm" do %>
            <i class="fas fa-arrow-left me-1"></i>Volver al Panel
          <% end %>
          <%= link_to "#", class: "btn btn-outline-primary btn-sm", data: { bs_toggle: "modal", bs_target: "#associateTeamModal" } do %>
            <i class="fas fa-link me-1"></i>Asociar a Club/Clan
          <% end %>
        </div>
      </div>

      <%# Información del equipo temporal %>
      <div class="alert alert-info">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1"><%= @team.name %></h6>
            <small class="text-muted">Equipo temporal - Expira <%= l(@team.expires_at, format: :short) %></small>
          </div>
          <div id="freeplayers_toggle">
            <%= render partial: "duels/freeplayers_toggle", locals: { duel: @duel } %>
          </div>
        </div>
      </div>

      <%# Estadísticas de convocatorias %>
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="text-success"><%= @team.callups.where(duel: @duel, status: :accepted).count %></h5>
              <small class="text-muted">Confirmados</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="text-warning"><%= @team.callups.where(duel: @duel, status: :pending).count %></h5>
              <small class="text-muted">Pendientes</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="text-danger"><%= @team.callups.where(duel: @duel, status: :rejected).count %></h5>
              <small class="text-muted">Rechazados</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="text-info"><%= @duel.duel_type %></h5>
              <small class="text-muted">Requeridos</small>
            </div>
          </div>
        </div>
      </div>

      <%# Jugadores de Clubs %>
      <% if @club_players.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-building me-2 text-primary"></i>Jugadores de Clubs
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <% @club_players.each do |player| %>
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <h6 class="card-title mb-1"><%= player.firstname %></h6>
                          <% player.memberships.includes(:joinable).each do |membership| %>
                            <% if membership.joinable.is_a?(Club) %>
                              <span class="badge bg-primary"><%= membership.joinable.name %></span>
                            <% end %>
                          <% end %>
                        </div>
                        <div class="callup-button" data-user-id="<%= player.id %>">
                          <%= render partial: "duels/callup_button", locals: { player: player, team: @team, duel: @duel } %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Jugadores de Clanes %>
      <% if @clan_players.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-shield-alt me-2 text-success"></i>Jugadores de Clanes
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <% @clan_players.each do |player| %>
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <h6 class="card-title mb-1"><%= player.firstname %></h6>
                          <% player.memberships.includes(:joinable).each do |membership| %>
                            <% if membership.joinable.is_a?(Clan) %>
                              <span class="badge bg-success"><%= membership.joinable.name %></span>
                            <% end %>
                          <% end %>
                        </div>
                        <div class="callup-button" data-user-id="<%= player.id %>">
                          <%= render partial: "duels/callup_button", locals: { player: player, team: @team, duel: @duel } %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Jugadores Libres %>
      <% if @free_players.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-user-friends me-2 text-info"></i>Jugadores Libres
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <% @free_players.each do |player| %>
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <h6 class="card-title mb-1"><%= player.firstname %></h6>
                          <span class="badge bg-info">Libre</span>
                        </div>
                        <div class="callup-button" data-user-id="<%= player.id %>">
                          <%= render partial: "duels/callup_button", locals: { player: player, team: @team, duel: @duel } %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Mensaje si no hay jugadores disponibles %>
      <% if @club_players.empty? && @clan_players.empty? && @free_players.empty? %>
        <div class="text-center py-5">
          <i class="fas fa-users fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No hay jugadores disponibles</h5>
          <p class="text-muted">Todos los jugadores ya han sido convocados o no tienes acceso a clubs/clanes.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Modal para asociar equipo a club/clan -->
<div class="modal fade" id="associateTeamModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-link me-2"></i>Asociar Equipo
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">¿Deseas asociar este equipo temporal a un club o clan?</p>
        <div class="d-grid gap-2">
          <%= link_to clubs_path, target: "_blank", class: "btn btn-outline-primary" do %>
            <i class="fas fa-building me-1"></i>Buscar Club
          <% end %>
          <%= link_to clans_path, target: "_blank", class: "btn btn-outline-success" do %>
            <i class="fas fa-shield-alt me-1"></i>Buscar Clan
          <% end %>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<%# JavaScript para manejar convocatorias %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Manejar clics en botones de convocatoria
  document.addEventListener('click', function(e) {
    if (e.target.closest('.callup-button')) {
      const button = e.target.closest('.callup-button');
      const userId = button.dataset.userId;
      
      if (e.target.classList.contains('btn-callup')) {
        e.preventDefault();
        callupPlayer(userId, button);
      }
    }
  });

  function callupPlayer(userId, buttonElement) {
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
    
    fetch(`/duels/<%= @duel.id %>/callup_player`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ user_id: userId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        buttonElement.innerHTML = '<i class="fas fa-clock me-1"></i>Pendiente';
        buttonElement.querySelector('button').classList.remove('btn-primary');
        buttonElement.querySelector('button').classList.add('btn-warning');
        buttonElement.querySelector('button').disabled = true;
        
        // Mostrar notificación
        showNotification(data.message, 'success');
      } else {
        buttonElement.innerHTML = originalText;
        showNotification(data.message, 'warning');
      }
    })
    .catch(error => {
      buttonElement.innerHTML = originalText;
      showNotification('Error al convocar jugador', 'error');
    });
  }

  function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
    const alertHtml = `
      <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      const alert = document.querySelector('.alert');
      if (alert) alert.remove();
    }, 5000);
  }
});
</script> 