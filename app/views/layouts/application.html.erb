<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Leagend" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mapbox-token" content="<%= Rails.application.credentials.dig(:mapbox, :public_token) %>">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload", media: "all" %>
    <%= javascript_importmap_tags %>
    
    <%# Assets de Mapbox - previene duplicados %>
    <%= render 'shared/mapbox_assets' %>

    <%# Variables JavaScript para el usuario logueado %>
    <% if user_signed_in? %>
      <script nonce="<%= content_security_policy_nonce %>">
        window.LEAGEND_USER_SIGNED_IN = true;
        window.LEAGEND_USER_HAS_COUNTRY = <%= current_user.current_country.present? %>;
        window.LEAGEND_USER_HAS_CITY = <%= current_user.current_city.present? %>;
        window.LEAGEND_USER_LAT = <%= current_user.current_latitude.present? ? current_user.current_latitude : 'null' %>;
        window.LEAGEND_USER_LNG = <%= current_user.current_longitude.present? ? current_user.current_longitude : 'null' %>;
      </script>
    <% else %>
      <script nonce="<%= content_security_policy_nonce %>">
        window.LEAGEND_USER_SIGNED_IN = false;
        window.LEAGEND_USER_HAS_COUNTRY = false;
        window.LEAGEND_USER_HAS_CITY = false;
        window.LEAGEND_USER_LAT = null;
        window.LEAGEND_USER_LNG = null;
      </script>
    <% end %>

    <%# CSS de Flatpickr %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!--bahamon.dev-->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  </head>

  <body data-controller="modal location-display">
    <!-- Bloque de información de ubicación -->
    <div class="location-info-bar" data-location-display-target="display">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <small class="text-muted">
              <i class="fas fa-map-marker-alt me-1"></i>
              <span id="leagend-header-location"
                    data-country="<%= current_user&.current_country %>"
                    data-city="<%= current_user&.current_city %>"
                    data-lat="<%= current_user&.current_latitude %>"
                    data-lng="<%= current_user&.current_longitude %>">
                <% location = current_user_location %>
                <% if has_location_data?(location) %>
                  Ubicación: <%= format_location_display(location) %>
                <% else %>
                  <em>Detectando ubicación...</em>
                <% end %>
              </span>
              

            </small>
          </div>
        </div>
      </div>
    </div>

    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <%= link_to 'Leagend', root_path, class: 'navbar-brand' %>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarText">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <%= link_to 'Inicio', root_path, class: 'nav-link' %>
            </li>
            <li class="nav-item">
              <%= link_to 'Clubs', clubs_path, class: 'nav-link' %>
            </li>
            <li class="nav-item">
              <%= link_to 'Clans', clans_path, class: 'nav-link' %>
            </li>
            <li class="nav-item">
              <%= link_to "Discover duels", open_duels_path, class: "nav-link" %>
            </li>
            <li class="nav-item">
              <%= link_to "Arenas", arenas_path, class: "nav-link" %>
            </li>
          </ul>

          <ul class="navbar-nav mb-2 mb-lg-0">
            <% if user_signed_in? %>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <% if current_user.avatar.attached? %>
                    <%= image_tag current_user.avatar, class: "rounded-circle me-2", alt: "Avatar", size: "30x30" %>
                  <% end %>
                  <%= current_user.firstname.presence || current_user.email %>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                  <li><%= link_to 'Nuevo evento', when_duels_path, class: 'dropdown-item' %></li>
                  <li><%= link_to "Mis Duelos", my_duels_duels_path, class: "dropdown-item" %></li>
                  <li><%= link_to 'Mi perfil', user_path(current_user), class: 'dropdown-item' %></li>
                  <li><%= link_to 'Notificaciones', notifications_path, class: 'dropdown-item' %></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><%= link_to 'Cerrar sesión', destroy_user_session_path, method: :delete, class: 'dropdown-item text-danger', data: { controller: 'sign-out', action: 'click->sign-out#handleSignOut', 'sign-out-target': 'link' } %></li>
                </ul>
              </li>
            <% else %>
              <li class="nav-item">
                <%= link_to 'Iniciar sesión', new_user_session_path, class: 'nav-link' %>
              </li>
              <li class="nav-item">
                <%= link_to 'Registrarse', new_user_registration_path, class: 'nav-link' %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </nav>


    <p class="notice"><%= notice %></p>
    <p class="alert"><%= alert %></p>
    
    <!-- Widget de ubicación opcional -->
    <div class="container-fluid">
      <div class="row justify-content-end">
        <div class="col-md-3 col-lg-2">
          <%= render 'shared/location_widget' %>
        </div>
      </div>
    </div>
    
    <%= yield %>

    <!--bahamon.dev-->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
      
      <!-- ===== LEAGEND GEO FALLBACK START ===== -->
      <script nonce="<%= content_security_policy_nonce %>">
      // Idempotencia de runtime: evita doble ejecución si el bloque existe dos veces por cache de Turbo
      if (!window.__LEAGEND_GEO_BOOTSTRAPPED__) {
        window.__LEAGEND_GEO_BOOTSTRAPPED__ = true;

        (function(){
          // Guardas: no ejecutar si no existe el span
          var target = document.getElementById('leagend-header-location');
          if (!target) return;

          // Variables de sesión expuestas por el layout (si no existen, defínelas)
          if (typeof window.LEAGEND_USER_SIGNED_IN === 'undefined') {
            window.LEAGEND_USER_SIGNED_IN = <%= user_signed_in? %>;
          }
          if (typeof window.LEAGEND_USER_HAS_COUNTRY === 'undefined') {
            window.LEAGEND_USER_HAS_COUNTRY = <%= current_user&.current_country.present? %>;
          }
          if (typeof window.LEAGEND_USER_HAS_CITY === 'undefined') {
            window.LEAGEND_USER_HAS_CITY = <%= current_user&.current_city.present? %>;
          }

          // Si no está logueado o ya tiene country+city, no hacemos nada
          if (!window.LEAGEND_USER_SIGNED_IN) return;
          if (window.LEAGEND_USER_HAS_COUNTRY && window.LEAGEND_USER_HAS_CITY) return;

          // Evitar repetir dentro de la sesión del navegador
          if (sessionStorage.getItem('leagend.backfill_done') === '1') return;

          function paint(country, city){
            try {
              var text = 'Ubicación: ';
              if (city && country) text += city + ', ' + country;
              else if (country)   text += country;
              else if (city)      text += city;
              else                text += 'Ubicación no configurada';
              target.textContent = text;
            } catch(_) {}
          }

          function csrf(){
            var m = document.querySelector('meta[name="csrf-token"]');
            return m && m.content;
          }

          function persist(payload){
            try {
              fetch('/geo/update', {
                method: 'PATCH',
                credentials: 'same-origin',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRF-Token': csrf() || ''
                },
                body: JSON.stringify(payload)
              }).catch(function(){});
            } catch(_){}
          }

          // Paso A: usar cache del invitado (localStorage) si existe
          var country = localStorage.getItem('leagend.country');
          var city    = localStorage.getItem('leagend.city');
          var latStr  = localStorage.getItem('leagend.lat');
          var lngStr  = localStorage.getItem('leagend.lng');
          var lat = latStr ? parseFloat(latStr) : null;
          var lng = lngStr ? parseFloat(lngStr) : null;

          if ((country || city)) {
            paint(country, city);
            var payload = { country: country || undefined, city: city || undefined };
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
              payload.latitude  = lat;
              payload.longitude = lng;
            }
            persist(payload);
            sessionStorage.setItem('leagend.backfill_done', '1');
            return; // listo
          }

          // Paso B: si hay coords pero no country/city → reverse geocoding
          var mapboxTokenMeta = document.querySelector('meta[name="mapbox-token"]');
          var mapboxToken = mapboxTokenMeta && mapboxTokenMeta.content;
          function reverseGeocode(lat, lng) {
            if (!mapboxToken || !Number.isFinite(lat) || !Number.isFinite(lng)) return Promise.reject();
            var url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' +
                      encodeURIComponent(lng + ',' + lat) +
                      '.json?types=place,region,country&language=es&access_token=' + encodeURIComponent(mapboxToken);

            var ctrl = new AbortController();
            var t = setTimeout(function(){ ctrl.abort(); }, 2500);

            return fetch(url, { signal: ctrl.signal })
              .then(function(r){ clearTimeout(t); return r.ok ? r.json() : Promise.reject(); })
              .then(function(j){
                if (!j || !j.features || !j.features.length) return Promise.reject();
                var f = j.features;

                var place = f.find(function(x){ return x.place_type && x.place_type.indexOf('place') !== -1; }) ||
                            f.find(function(x){ return x.place_type && x.place_type.indexOf('locality') !== -1; });

                var country = null;
                var city    = null;

                if (place && place.text) city = place.text;

                // buscar país en el contexto
                var any = place || f[0];
                if (any && any.context) {
                  var c = any.context.find(function(c){ return c.id && c.id.indexOf('country') === 0; });
                  if (c && c.text) country = c.text;
                }

                if (!country) {
                  var directCountry = f.find(function(x){ return x.place_type && x.place_type.indexOf('country') !== -1; });
                  if (directCountry && directCountry.text) country = directCountry.text;
                }

                if (country || city) return {country: country, city: city};
                return Promise.reject();
              });
          }

          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            reverseGeocode(lat, lng).then(function(res){
              paint(res.country, res.city);
              persist({ country: res.country, city: res.city, latitude: lat, longitude: lng });
              localStorage.setItem('leagend.country', res.country || '');
              localStorage.setItem('leagend.city', res.city || '');
              sessionStorage.setItem('leagend.backfill_done', '1');
            }).catch(function(){});
            return;
          }

          // Paso C: pedir geolocalización HTML5 si no hay nada aún
          if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(function(pos){
              var lat = pos && pos.coords && pos.coords.latitude;
              var lng = pos && pos.coords && pos.coords.longitude;
              if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

              localStorage.setItem('leagend.lat', String(lat));
              localStorage.setItem('leagend.lng', String(lng));

              reverseGeocode(lat, lng).then(function(res){
                paint(res.country, res.city);
                persist({ country: res.country, city: res.city, latitude: lat, longitude: lng });
                localStorage.setItem('leagend.country', res.country || '');
                localStorage.setItem('leagend.city', res.city || '');
                sessionStorage.setItem('leagend.backfill_done', '1');
              }).catch(function(){
                // como mínimo persiste coords
                persist({ latitude: lat, longitude: lng });
                sessionStorage.setItem('leagend.backfill_done', '1');
              });
            }, function(){ /* usuario rechazó o error; no hacemos nada */ }, { timeout: 8000 });
          }
        })();
      }
      </script>
      <!-- ===== LEAGEND GEO FALLBACK END ===== -->
      
  </body>
</html>
