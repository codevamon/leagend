<%# Assets de Mapbox con Geocoder para autocompletado %>
<%= render 'shared/mapbox_assets', load_geocoder: true %>

<!-- Meta tag para token de Mapbox -->
<meta name="mapbox-token" content="<%= Rails.application.credentials.dig(:mapbox, :public_token) %>">

<div class="container mt-4"
     data-controller="duel-steps modal arena-location"
     data-arena-location-editable-value="true"
     data-context="duel">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Header -->
      <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">
          <i class="fas fa-trophy me-2"></i>Crear Nuevo Duelo
        </h2>
        <p class="text-muted">Configura tu duelo paso a paso</p>
      </div>

      <!-- Formulario principal -->
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <%= form_with model: @duel, local: true, class: "needs-validation", novalidate: true do |f| %>
            
            <!-- Paso 1: Ubicación, Arenas y Árbitro -->
            <fieldset data-duel-steps-target="step" data-step="1" class="step-content">
              <div class="step-header mb-4">
                <h4 class="step-title">
                  <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                  Configuración del Duelo
                </h4>
                <p class="step-description text-muted">
                  Define ubicación, selecciona arena y configura árbitro
                </p>
              </div>

              <div class="container">
                <div class="row">
                  <!-- Columna izquierda: Inputs, búsqueda, grid y árbitro -->
                  <div class="col-lg-6">
                    <!-- Inputs de ubicación -->
                    <div class="location-inputs mb-4">
                      <h6 class="text-muted mb-3">
                        <i class="fas fa-map-marker-alt me-2"></i>Ubicación del Duelo
                      </h6>
                      
                      <div class="mb-3">
                        <%= f.label :country, "País", class: "form-label fw-semibold" %>
                        <%= f.text_field :country, 
                            class: "form-control", 
                            required: true,
                            placeholder: "Ej: Colombia",
                            data: { 
                              arena_location_target: "country",
                              action: "input->arena-location#schedule"
                            } %>
                        <div data-arena-location-target="geocoderCountry" class="geocoder-container"></div>
                      </div>

                      <div class="mb-3">
                        <%= f.label :city, "Ciudad", class: "form-label fw-semibold" %>
                        <%= f.text_field :city, 
                            class: "form-control", 
                            required: true,
                            placeholder: "Ej: Bogotá",
                            data: { 
                              arena_location_target: "city",
                              action: "input->arena-location#schedule"
                            } %>
                        <div data-arena-location-target="geocoderCity" class="geocoder-container"></div>
                      </div>

                      <div class="mb-3" id="address-field">
                        <%= f.label :address, "Dirección", class: "form-label fw-semibold" %>
                        <div class="input-group">
                          <%= f.text_field :address, 
                              class: "form-control", 
                              required: true,
                              placeholder: "Calle 123 #45-67, barrio...",
                              data: { 
                                arena_location_target: "address",
                                action: "keydown.enter->arena-location#submitAddressSearch input->arena-location#onAddressInput"
                              },
                              autocomplete: "street-address",
                              "aria-describedby": "address-search-btn" %>
                          <button
                            class="btn btn-outline-secondary"
                            type="button"
                            id="address-search-btn"
                            title="Buscar dirección"
                            data-action="click->arena-location#submitAddressSearch"
                          >
                            <i class="fas fa-search" aria-hidden="true"></i>
                            <span class="visually-hidden">Buscar</span>
                          </button>
                        </div>
                        <div class="form-text">Escribe la dirección y presiona Enter o el botón de buscar.</div>
                        <div data-arena-location-target="geocoderAddress" class="geocoder-container"></div>
                      </div>

                      <div class="mb-3">
                        <%= f.label :neighborhood, "Barrio", class: "form-label fw-semibold" %>
                        <%= f.text_field :neighborhood, 
                            class: "form-control", 
                            placeholder: "Ej: Chapinero",
                            data: { 
                              arena_location_target: "neighborhood"
                            } %>
                      </div>

                      <!-- Campos hidden para lat/lng -->
                      <%= f.hidden_field :latitude, data: { arena_location_target: "latitude" } %>
                      <%= f.hidden_field :longitude, data: { arena_location_target: "longitude" } %>
                    </div>

                    <!-- Búsqueda de arenas -->
                    <div class="arena-search mb-3">
                      <label class="form-label fw-semibold">
                        <i class="fas fa-search me-2"></i>Buscar Arenas
                      </label>
                      <input type="text" 
                             placeholder="Buscar arena..." 
                             class="form-control mb-3"
                             data-duel-steps-target="arenaSearch" 
                             data-action="input->duel-steps#onSearchInput">
                    </div>

                    <!-- Grid de arenas -->
                    <%# 
                      ESTRUCTURA DEL ARENA-SELECT-FRAME:
                      - NO es un turbo-frame real, es un div que se reemplaza via turbo_stream.replace
                      - El controlador duel-steps está en el ancestro (línea 7)
                      - selectable: true se pasa a todas las cards renderizadas
                      - DELEGACIÓN DE EVENTOS ACTIVADA: data-action="click->duel-steps#onArenaListClick"
                        en el contenedor para capturar clics incluso después de re-renders de Turbo
                    %>
                    <div id="arena-select-frame"
                         class="row g-3"
                         data-duel-steps-target="arenaGrid"
                         data-action="click->duel-steps#onArenaListClick">
                      <%= render partial: "arenas/arena_card", collection: @arenas, as: :arena, locals: { selectable: true } %>
                    </div>

                    <!-- Botón Crear Arena -->
                    <div class="text-center mt-3">
                      <%= link_to "Crear Nueva Arena", new_arena_path(quick: true), 
                          class: "btn btn-outline-primary",
                          data: { 
                            turbo_frame: "modal",
                            action: "click->modal#open"
                          } %>
                      <small class="d-block text-muted mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Crea una arena personalizada para tu duelo
                      </small>
                    </div>

                    <!-- Mensaje cuando no hay arenas cercanas -->
                    <div id="no-arenas-message" class="alert alert-info text-center mt-3 d-none">
                      <i class="fas fa-info-circle me-2"></i>
                      <strong>No hay arenas cercanas en un radio de 3 km.</strong><br>
                      <small class="text-muted">Se muestran las 5 arenas más cercanas disponibles.</small>
                    </div>

                    <!-- Checkbox árbitro -->
                    <div class="form-check mt-3">
                      <%= check_box_tag :assign_referee, "1", false, class: "form-check-input", id: "assign_referee" %>
                      <label class="form-check-label" for="assign_referee">
                        <i class="fas fa-user-tie me-2"></i>Asignar árbitro automáticamente
                      </label>
                    </div>

                    <!-- Hidden selección de arena -->
                    <%= hidden_field_tag "duel[arena_id]", nil, id: "duel_arena_id", data: { duel_steps_target: "arenaId" } %>
                  </div>

                  <!-- Columna derecha: Mapa -->
                  <div class="col-lg-6">
                    <div class="map-section">
                      <h6 class="text-muted mb-3">
                        <i class="fas fa-map me-2"></i>Mapa
                      </h6>
                      <div id="location-map" 
                           data-arena-location-target="map"  data-arena-location-editable-value="true"
                           style="height:420px;border-radius:8px"></div>
                                                             <small class="text-muted d-block mt-2">
           <i class="fas fa-info-circle me-1"></i>Mueve el mapa; el marcador de ubicación se mantiene centrado.
         </small>
                    </div>
                  </div>
                </div>
              </div>
            </fieldset>

            <!-- Paso 2: Fecha y Hora -->
            <fieldset data-duel-steps-target="step" data-step="2" class="step-content d-none">
              <div class="step-header mb-4">
                <h4 class="step-title">
                  <i class="fas fa-calendar-alt me-2 text-success"></i>
                  ¿Cuándo será el duelo?
                </h4>
                <p class="step-description text-muted">
                  Selecciona fecha, hora y duración del duelo
                </p>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-4">
                    <%= f.label :starts_at, "Fecha y Hora", class: "form-label fw-semibold" %>
                    <%= f.datetime_local_field :starts_at, 
                        class: "form-control", 
                        required: true,
                        min: Time.current.strftime("%Y-%m-%dT%H:%M"),
                        placeholder: "Selecciona fecha y hora" %>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-4">
                    <%= f.label :duration, "Duración", class: "form-label fw-semibold" %>
                    <%= f.select :duration, 
                        options_for_select([
                          ['90 minutos', 1.5],
                          ['2 horas', 2],
                          ['2.5 horas', 2.5],
                          ['3 horas', 3],
                          ['3.5 horas', 3.5],
                          ['4 horas', 4]
                        ], 1.5),
                        {},
                        { class: "form-select", required: true } %>
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      Duración por defecto: 90 minutos
                    </small>
                  </div>
                </div>
              </div>

              <div class="mb-4">
                <%= f.label :duel_type, "Tipo de Duelo", class: "form-label fw-semibold" %>
                <%= f.select :duel_type, 
                    Duel.duel_types.keys.map { |t| [t.titleize, t] },
                    { selected: 'friendly' },
                    { class: "form-select", required: true } %>
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  El tipo determina las reglas y formato del duelo
                </small>
              </div>
            </fieldset>
            
            <!-- Paso 3: Resumen -->
            <fieldset data-duel-steps-target="step" data-step="3" class="step-content d-none">
              <div class="step-header mb-4">
                <h4 class="step-title">
                  <i class="fas fa-clipboard-check me-2 text-info"></i>
                  Resumen del Duelo
                </h4>
                <p class="step-description text-muted">
                  Revisa los detalles antes de crear el duelo
                </p>
              </div>

              <div class="duel-summary">
                <div class="row">
                  <div class="col-md-6">
                    <div class="summary-section mb-4">
                      <h6 class="summary-title text-primary">
                        <i class="fas fa-map-marker-alt me-2"></i>Ubicación
                      </h6>
                      <div class="summary-content">
                        <p class="mb-1">
                          <strong>País:</strong> <span id="summary-country">-</span>
                        </p>
                        <p class="mb-1">
                          <strong>Ciudad:</strong> <span id="summary-city">-</span>
                        </p>
                        <p class="mb-1">
                          <strong>Dirección:</strong> <span id="summary-address">-</span>
                        </p>
                        <p class="mb-0">
                          <strong>Barrio:</strong> <span id="summary-neighborhood">-</span>
                        </p>
                      </div>
                    </div>

                    <div class="summary-section mb-4">
                      <h6 class="summary-title text-success">
                        <i class="fas fa-calendar-alt me-2"></i>Fecha y Hora
                      </h6>
                      <div class="summary-content">
                        <p class="mb-1">
                          <strong>Fecha:</strong> <span id="summary-date">-</span>
                        </p>
                        <p class="mb-1">
                          <strong>Hora:</strong> <span id="summary-time">-</span>
                        </p>
                        <p class="mb-0">
                          <strong>Duración:</strong> <span id="summary-duration">-</span>
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="summary-section mb-4">
                      <h6 class="summary-title text-warning">
                        <i class="fas fa-building me-2"></i>Arena
                      </h6>
                      <div class="summary-content">
                        <p class="mb-0">
                          <strong>Seleccionada:</strong> 
                          <span id="summary-arena">Sin arena seleccionada</span>
                        </p>
                      </div>
                    </div>

                    <div class="summary-section mb-4">
                      <h6 class="summary-title text-info">
                        <i class="fas fa-user-tie me-2"></i>Árbitro
                      </h6>
                      <div class="summary-content">
                        <p class="mb-0">
                          <strong>Asignación:</strong> 
                          <span id="summary-referee">Sin árbitro asignado</span>
                        </p>
                      </div>
                    </div>

                    <div class="summary-section">
                      <h6 class="summary-title text-secondary">
                        <i class="fas fa-gamepad me-2"></i>Tipo de Duelo
                      </h6>
                      <div class="summary-content">
                        <p class="mb-0">
                          <strong>Tipo:</strong> <span id="summary-duel-type">-</span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Mapa en miniatura -->
                <div class="summary-map-section mt-4">
                  <h6 class="summary-title text-primary">
                    <i class="fas fa-map me-2"></i>Ubicación del Duelo
                  </h6>
                  <div id="summary-map" 
                       data-arena-location-target="summaryMap"
                       style="height: 200px; border-radius: 8px; border: 1px solid #dee2e6;">
                  </div>
                  <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>Ubicación seleccionada para el duelo
                  </small>
                </div>

                <!-- Disclaimer si no hay arena -->
                <div id="no-arena-disclaimer" class="alert alert-warning mt-4 d-none">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Nota:</strong> Al no seleccionar una arena específica, tu duelo será visible para todos los jugadores 
                  y podrás recibir desafíos de equipos que busquen rivales. Podrás asignar una arena más tarde desde el panel de gestión.
                </div>
              </div>
            </fieldset>

            <!-- Navegación entre pasos -->
            <div class="step-navigation d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
              <button type="button" 
                      class="btn btn-outline-secondary"
                      data-duel-steps-target="prevBtn"
                      data-action="click->duel-steps#previous">
                <i class="fas fa-arrow-left me-2"></i>Anterior
              </button>

              <div class="step-actions">
                <button type="button" 
                        class="btn btn-primary"
                        data-duel-steps-target="nextBtn"
                        data-action="click->duel-steps#next">
                  Siguiente<i class="fas fa-arrow-right ms-2"></i>
                </button>

                <%= f.submit "Crear Duelo", 
                    class: "btn btn-success btn-lg",
                    data: { duel_steps_target: "submitBtn" } %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Información adicional -->
      <div class="card mt-4 border-0 info-card">
        <div class="card-body">
          <h6 class="fw-semibold mb-3">
            <i class="fas fa-lightbulb me-2 text-warning"></i>¿Cómo funciona?
          </h6>
          <ul class="list-unstyled mb-0">
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>
              <strong>Crea el duelo:</strong> Configura ubicación, fecha y tipo
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>
              <strong>Equipo automático:</strong> Se crea un equipo temporal automáticamente
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>
              <strong>Convoca jugadores:</strong> Invita a tu equipo desde el panel
            </li>
            <li class="mb-0">
              <i class="fas fa-check text-success me-2"></i>
              <strong>¡Juega!</strong> Inicia el duelo cuando esté todo listo
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Contenedor para mensajes flash -->
  <div id="flash"></div>
  
  <!-- Turbo Frame para modal -->
  <%= turbo_frame_tag "modal" %>
</div>

 